#!/usr/bin/env python3
"""
oaskd - OpenCode ask daemon.

Implements Scheme-2: per-session serialized sending + storage-driven reply extraction with req_id.
"""
from __future__ import annotations

import argparse
import os
import sys
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))

from compat import setup_windows_encoding

setup_windows_encoding()

from oaskd_daemon import OaskdServer, shutdown_daemon


def _parse_listen(value: str) -> tuple[str, int]:
    value = (value or "").strip()
    if not value:
        return "127.0.0.1", 0
    if ":" not in value:
        return value, 0
    host, port_s = value.rsplit(":", 1)
    return host or "127.0.0.1", int(port_s or "0")


def main(argv: list[str]) -> int:
    ap = argparse.ArgumentParser(description="oask daemon (OpenCode)")
    ap.add_argument("--listen", default=os.environ.get("CCB_OASKD_LISTEN", "127.0.0.1:0"), help="host:port (default 127.0.0.1:0)")
    ap.add_argument("--state-file", default=os.environ.get("CCB_OASKD_STATE_FILE", ""), help="Override state file path")
    ap.add_argument("--shutdown", action="store_true", help="Shutdown running daemon")
    args = ap.parse_args(argv[1:])

    state_file = Path(args.state_file).expanduser() if args.state_file else None

    if args.shutdown:
        ok = shutdown_daemon(state_file=state_file)
        return 0 if ok else 1

    host, port = _parse_listen(args.listen)
    server = OaskdServer(host=host, port=port, state_file=state_file)
    return server.serve_forever()


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))
