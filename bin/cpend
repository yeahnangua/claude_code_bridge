#!/usr/bin/env python3
"""
cpend - View latest Codex reply
"""

import json
import os
import argparse
import sys
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))
from compat import setup_windows_encoding
setup_windows_encoding()

from i18n import t

try:
    from cli_output import EXIT_ERROR, EXIT_NO_REPLY, EXIT_OK
    from codex_comm import CodexLogReader, SESSION_ID_PATTERN
    from ccb_protocol import strip_trailing_markers
    from pane_registry import load_registry_by_session_id, load_registry_by_claude_pane
    from session_utils import find_project_session_file
except ImportError as exc:
    print(f"Import failed: {exc}")
    sys.exit(1)

def _debug_enabled() -> bool:
    return (os.environ.get("CCB_DEBUG") in ("1", "true", "yes")) or (os.environ.get("CPEND_DEBUG") in ("1", "true", "yes"))


def _debug(message: str) -> None:
    if not _debug_enabled():
        return
    print(f"[DEBUG] {message}", file=sys.stderr)


def _load_session_log_path() -> tuple[Path | None, str | None]:
    """Load codex_session_path from .codex-session (or .ccb_config/.codex-session) if exists"""
    session_file = find_project_session_file(Path.cwd(), ".codex-session")
    if not session_file:
        return None, None
    try:
        with session_file.open("r", encoding="utf-8-sig") as f:
            data = json.load(f)
        path_str = data.get("codex_session_path")
        session_id = data.get("codex_session_id")
        if path_str:
            return Path(path_str).expanduser(), session_id
    except Exception as exc:
        _debug(f"Failed to read .codex-session ({session_file}): {exc}")
    return None, None


def _load_registry_log_path() -> tuple[Path | None, dict | None]:
    session_id = (os.environ.get("CODEX_SESSION_ID") or "").strip()
    if session_id:
        record = load_registry_by_session_id(session_id)
        if record:
            path_str = record.get("codex_session_path")
            if path_str:
                path = Path(path_str).expanduser()
                _debug(f"Using registry by CODEX_SESSION_ID: {path}")
                return path, record

    pane_id = (os.environ.get("WEZTERM_PANE") or "").strip()
    if pane_id:
        record = load_registry_by_claude_pane(pane_id)
        if record:
            path_str = record.get("codex_session_path")
            if path_str:
                path = Path(path_str).expanduser()
                _debug(f"Using registry by WEZTERM_PANE: {path}")
                return path, record
    return None, None


def _derive_session_filter(log_path: Path | None, registry_record: dict | None, session_id: str | None) -> str | None:
    if registry_record:
        reg_id = registry_record.get("codex_session_id")
        if isinstance(reg_id, str) and reg_id:
            return reg_id
    if session_id:
        return session_id
    if log_path:
        for source in (log_path.stem, log_path.name):
            match = SESSION_ID_PATTERN.search(source)
            if match:
                return match.group(0)
        return log_path.name
    return None

def _parse_n(argv: list[str]) -> int:
    if len(argv) <= 1:
        return 1
    try:
        n = int(argv[1])
    except ValueError:
        return 1
    return max(1, n)


def main(argv: list[str]) -> int:
    try:
        parser = argparse.ArgumentParser(prog="cpend", add_help=True)
        parser.add_argument("n", nargs="?", type=int, default=1, help="Show the latest N conversations")
        parser.add_argument("--raw", action="store_true", help="Do not strip protocol/harness marker lines")
        args = parser.parse_args(argv[1:])
        n = max(1, int(args.n or 1))
        raw = bool(args.raw)

        registry_log_path, registry_record = _load_registry_log_path()
        session_log_path, session_id = _load_session_log_path()

        log_path = registry_log_path or session_log_path
        if not registry_log_path and log_path:
            _debug(f"Using codex_session_path from .codex-session: {log_path}")

        session_filter = _derive_session_filter(log_path, registry_record, session_id)
        reader = CodexLogReader(log_path=log_path, session_id_filter=session_filter)

        if n > 1:
            conversations = reader.latest_conversations(n)
            if not conversations:
                print(t("no_reply_available", provider="Codex"), file=sys.stderr)
                return EXIT_NO_REPLY
            for i, (question, reply) in enumerate(conversations):
                if question:
                    print(f"Q: {question}")
                cleaned = reply if raw else strip_trailing_markers(reply or "")
                print(f"A: {cleaned}")
                if i < len(conversations) - 1:
                    print("---")
            return EXIT_OK

        message = reader.latest_message()
        if not message:
            print(t("no_reply_available", provider="Codex"), file=sys.stderr)
            return EXIT_NO_REPLY
        print(message if raw else strip_trailing_markers(message))
        return EXIT_OK
    except Exception as exc:
        if _debug_enabled():
            import traceback

            traceback.print_exc()
        print(f"[ERROR] {t('execution_failed', error=exc)}", file=sys.stderr)
        return EXIT_ERROR


if __name__ == "__main__":
    sys.exit(main(sys.argv))
