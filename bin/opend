#!/usr/bin/env python3
"""
opend - View latest OpenCode reply
"""

import json
import os
import sys
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))
from compat import setup_windows_encoding

setup_windows_encoding()

from i18n import t


def _load_project_id() -> str:
    """Load project_id from .opencode-session or compute from cwd"""
    work_dir = Path.cwd()

    try:
        from session_utils import find_project_session_file
    except Exception:
        find_project_session_file = None

    session_file = find_project_session_file(Path.cwd(), ".opencode-session") if find_project_session_file else (Path.cwd() / ".opencode-session")

    if session_file and session_file.exists():
        try:
            with session_file.open('r', encoding='utf-8-sig') as f:
                data = json.load(f)
            wd = data.get('work_dir')
            if wd:
                work_dir = Path(wd)
        except Exception:
            pass

    from opencode_comm import compute_opencode_project_id
    return compute_opencode_project_id(work_dir)


try:
    from cli_output import EXIT_ERROR, EXIT_NO_REPLY, EXIT_OK
    from opencode_comm import OpenCodeLogReader
except ImportError as exc:
    print(f"Import failed: {exc}", file=sys.stderr)
    sys.exit(1)


def _debug_enabled() -> bool:
    return (os.environ.get("CCB_DEBUG") in ("1", "true", "yes")) or (os.environ.get("OPEND_DEBUG") in ("1", "true", "yes"))


def main(argv: list[str]) -> int:
    try:
        if len(argv) > 1 and argv[1] in ("-h", "--help"):
            print("Usage: opend", file=sys.stderr)
            return EXIT_OK

        project_id = _load_project_id()
        reader = OpenCodeLogReader(project_id=project_id)
        message = reader.latest_message()
        if not message:
            print(t("no_reply_available", provider="OpenCode"), file=sys.stderr)
            return EXIT_NO_REPLY
        print(message)
        return EXIT_OK
    except Exception as exc:
        if _debug_enabled():
            import traceback

            traceback.print_exc()
        print(f"[ERROR] {t('execution_failed', error=exc)}", file=sys.stderr)
        return EXIT_ERROR


if __name__ == "__main__":
    sys.exit(main(sys.argv))
