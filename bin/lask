#!/usr/bin/env python3
"""
lask - Send a message to the active Claude pane (best-effort).

This is intended for use *from inside* another AI CLI (e.g. Codex) so you can
dispatch a prompt back to Claude quickly.

Notes:
- It uses CCB's pane registry (written by `ccb up ...`) to locate the Claude pane.
- It only sends text; it does not wait for/parse Claude replies.
"""

from __future__ import annotations

import json
import os
import sys
from pathlib import Path
from typing import Optional

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))

from compat import setup_windows_encoding

setup_windows_encoding()

from pane_registry import load_registry_by_session_id
from session_utils import find_project_session_file
from terminal import TmuxBackend, WeztermBackend


def _usage() -> None:
    print("Usage: lask <message>", file=sys.stderr)


def _read_json(path: Path) -> dict:
    try:
        raw = path.read_text(encoding="utf-8-sig")
        obj = json.loads(raw)
        return obj if isinstance(obj, dict) else {}
    except Exception:
        return {}


def _detect_ccb_session_id() -> Optional[str]:
    # Prefer any explicit env (useful in nested tools).
    for key in ("CCB_SESSION_ID", "CODEX_SESSION_ID", "GEMINI_SESSION_ID", "OPENCODE_SESSION_ID"):
        v = (os.environ.get(key) or "").strip()
        if v:
            return v

    # Fallback to project session file (Codex is most likely present).
    for filename in (".codex-session", ".gemini-session", ".opencode-session"):
        path = find_project_session_file(Path.cwd(), filename)
        if not path:
            continue
        data = _read_json(path)
        sid = data.get("session_id")
        if isinstance(sid, str) and sid.strip():
            return sid.strip()
    return None


def _backend_for_claude_pane(claude_pane_id: str):
    # tmux pane_id is `%xx`; WezTerm pane_id is a number-like string.
    if claude_pane_id.startswith("%"):
        return TmuxBackend()
    return WeztermBackend()


def main(argv: list[str]) -> int:
    if len(argv) > 1 and argv[1] in ("-h", "--help"):
        _usage()
        return 0

    message = " ".join(argv[1:]).strip() if len(argv) > 1 else ""
    if not message and not sys.stdin.isatty():
        message = sys.stdin.read().strip()
    if not message:
        _usage()
        return 1

    session_id = _detect_ccb_session_id()
    if not session_id:
        print("[ERROR] lask: cannot locate CCB session_id (no session file/env found)", file=sys.stderr)
        return 1

    record = load_registry_by_session_id(session_id)
    if not record:
        print(f"[ERROR] lask: no registry found for session_id={session_id}", file=sys.stderr)
        return 1

    claude_pane_id = str(record.get("claude_pane_id") or "").strip()
    if not claude_pane_id:
        print(f"[ERROR] lask: registry missing claude_pane_id for session_id={session_id}", file=sys.stderr)
        print("Hint: run `ccb up ...` from inside WezTerm/tmux so Claude has a pane id to target.", file=sys.stderr)
        return 1

    backend = _backend_for_claude_pane(claude_pane_id)
    try:
        backend.send_text(claude_pane_id, message)
    except Exception as exc:
        print(f"[ERROR] lask: send failed: {exc}", file=sys.stderr)
        return 1

    return 0


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))
