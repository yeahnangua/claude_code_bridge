# =============================================================================
# CCB (Claude Code Bridge) tmux configuration
# Compatible with Oh My Tmux (gpakosz/.tmux)
# Auto-installed by ccb install.sh
# =============================================================================

# -----------------------------------------------------------------------------
# General Settings
# -----------------------------------------------------------------------------

# Enable mouse support (click to switch pane, scroll, drag to resize)
set -g mouse on

# Use vi mode for copy mode
set-window-option -g mode-keys vi

# Larger history buffer
set -g history-limit 50000

# Faster escape time (better for vim/neovim)
set -sg escape-time 10

# Focus events for vim/neovim autoread
set -g focus-events on

# Enable system clipboard integration (OSC 52)
set -s set-clipboard on

# Better colors
set -g default-terminal "tmux-256color"
set -sa terminal-features ',xterm-256color:RGB'
set -sa terminal-overrides ',xterm-256color:Tc'

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# NOTE:
# CCB's status bar + pane title theming is enabled only while CCB is running.
# See: `@CCB_BIN_DIR@/ccb-tmux-on.sh` / `@CCB_BIN_DIR@/ccb-tmux-off.sh`.

# CCB script directory (filled by installer)
set -g @ccb_bin_dir "@CCB_BIN_DIR@"

# -----------------------------------------------------------------------------
# Copy Mode (vi-style) with System Clipboard
# -----------------------------------------------------------------------------

# Better scroll speed (2 lines per scroll instead of default 5)
bind -T copy-mode-vi WheelUpPane select-pane \; send-keys -X -N 2 scroll-up
bind -T copy-mode-vi WheelDownPane select-pane \; send-keys -X -N 2 scroll-down

# Vi-style copy mode bindings
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'C-v' send -X rectangle-toggle

# Copy to system clipboard (auto-detect: xclip for X11, wl-copy for Wayland, pbcopy for macOS)
# 'y' to copy and stay in copy mode, 'Enter' to copy and exit
if-shell 'command -v xclip' {
    bind-key -T copy-mode-vi 'y' send -X copy-pipe 'xclip -selection clipboard'
    bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel 'xclip -selection clipboard'
    bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'xclip -selection clipboard'
}
if-shell 'command -v wl-copy' {
    bind-key -T copy-mode-vi 'y' send -X copy-pipe 'wl-copy'
    bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel 'wl-copy'
    bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'wl-copy'
}
if-shell 'command -v pbcopy' {
    bind-key -T copy-mode-vi 'y' send -X copy-pipe 'pbcopy'
    bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel 'pbcopy'
    bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'pbcopy'
}

# Paste from system clipboard
bind-key p run-shell 'xclip -selection clipboard -o | tmux load-buffer - && tmux paste-buffer'

# (CCB theme is applied dynamically by ccb while running.)

# NOTE:
# We intentionally do NOT bind model-specific tmux keys (e.g. prefix+o/c/g),
# because they conflict with common tmux defaults and user workflows.
# If you want CCB navigation keys, add your own bindings in `~/.tmux.conf.local`.

# -----------------------------------------------------------------------------
# Pane Management
# -----------------------------------------------------------------------------

# Split panes using | and -
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Navigate panes with vim keys
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Resize panes with Shift + vim keys
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Zoom pane toggle
bind z resize-pane -Z

# Synchronize panes toggle (type in all panes)
bind S setw synchronize-panes

# -----------------------------------------------------------------------------
# Mouse Mode Toggle
# -----------------------------------------------------------------------------

bind m set -g mouse on \; display "Mouse ON"
bind M set -g mouse off \; display "Mouse OFF"

# -----------------------------------------------------------------------------
# Reload Config
# -----------------------------------------------------------------------------

bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Manually toggle CCB theme for current session (optional).
bind-key C run-shell "#{@ccb_bin_dir}/ccb-tmux-on.sh"
bind-key V run-shell "#{@ccb_bin_dir}/ccb-tmux-off.sh"

# -----------------------------------------------------------------------------
# Session Management
# -----------------------------------------------------------------------------

# Easy session switching
bind s choose-tree -Zs

# Kill session
bind X confirm-before -p "Kill session #S? (y/n)" kill-session

# -----------------------------------------------------------------------------
# Activity Monitoring
# -----------------------------------------------------------------------------

setw -g monitor-activity on
set -g visual-activity off

# -----------------------------------------------------------------------------
# Visual Styling / Theme (Tokyo Night inspired)
# -----------------------------------------------------------------------------

# Status Bar Position and Base Style
set -g status-position top
set -g status-justify left
set -g status-style 'bg=#1a1b26 fg=#c0caf5'
set -g status-interval 2

# Status Left: Session Name
set -g status-left-length 50
set -g status-left "#[fg=#15161e,bg=#7aa2f7,bold] ❐ #S #[fg=#7aa2f7,bg=#1a1b26] "

# Status Right: CCB Status + Time
# Using the @CCB_BIN_DIR@ placeholder which will be replaced during install
set -g status-right-length 100
set -g status-right "#[fg=#1a1b26,bg=#1a1b26]#[fg=#7aa2f7,bg=#1a1b26] #(@CCB_BIN_DIR@/ccb-status.sh compact) #[fg=#3b4261,bg=#1a1b26]#[fg=#7aa2f7,bg=#3b4261] %Y-%m-%d  %H:%M #[fg=#7aa2f7,bg=#3b4261]#[fg=#15161e,bg=#7aa2f7,bold] ❄ "

# Window Status (Inactive)
setw -g window-status-separator ""
setw -g window-status-format "#[fg=#1a1b26,bg=#1a1b26]#[fg=#565f89,bg=#1a1b26] #I  #W #[fg=#1a1b26,bg=#1a1b26]"

# Window Status (Active)
setw -g window-status-current-format "#[fg=#1a1b26,bg=#e0af68]#[fg=#15161e,bg=#e0af68,bold] #I  #W #[fg=#e0af68,bg=#1a1b26]"

# Pane Borders
set -g pane-border-style 'fg=#3b4261'
set -g pane-active-border-style 'fg=#7aa2f7'

# Message Style (Command Line)
set -g message-style 'fg=#7aa2f7 bg=#1a1b26 bold'
set -g message-command-style 'fg=#bb9af7 bg=#1a1b26'

# Mode Style (Copy Mode)
set -g mode-style 'fg=#1a1b26 bg=#7aa2f7 bold'

# Clock
setw -g clock-mode-colour '#7aa2f7'
setw -g clock-mode-style 24

# =============================================================================
# End of CCB tmux configuration
# =============================================================================
